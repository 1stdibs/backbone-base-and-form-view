//     Backbone.FormView 0.6.0
//     (c) 2014 James Ballantine, 1stdibs.com Inc.
//     Backbone.FormView may be freely distributed under the MIT license.
//     For all details and documentation:
//     https://github.com/1stdibs/backbone-base-and-form-view
!function(a){"use strict";var b=a.Backbone,c=a._;if("undefined"!=typeof module&&(c=require("underscore"),b=require("./backbone-baseview"),module.exports=b),!b||!b.BaseView)throw new Error("Backbone and Backbone.BaseView required");var d,e,f,g,h,i,j,k=b.Model,l=b.Collection,m=c.each,n=c.extend,o=c.defaults,p=c.clone,q=c.isUndefined,r=c.isFunction,s=c.isArray,t=c.result,u={disable:function(){return this.subs.each(function(a){r(a.disable)&&a.disable()}),this},enable:function(){return this.subs.each(function(a){r(a.enable)&&a.enable()}),this}},v=function(){var a=this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix():"";return a+this.fieldSetName+"-"},w=function(a,b,c){return a instanceof c?a:a===!0&&b instanceof c?b:b?(b=b.get(a),b instanceof c?b:null):null},x=function(a,b,c){return a?w(a,c,k)||c:w(b,c,k)||c},y=function(a,b,c,d){return a?w(a,c,l)||d:w(b,c,l)||null};b.FormView=b.BaseView.extend({tagName:"form",className:"form-horizontal",fieldAlias:{Text:"Backbone.fields.FieldView",RadioList:"Backbone.fields.RadioListView",CheckList:"Backbone.fields.CheckListView",Select:"Backbone.fields.SelectListView",FieldSet:"Backbone.FieldSetView",Checkbox:"Backbone.fields.CheckBoxView",CollectionField:"Backbone.CollectionFieldSetView"},template:c.template('<div data-fields=""></div>'),fieldsWrapper:"[data-fields]:first",initialize:function(a){a=this.options=o(a||{},this.options);var b=a.schema||this.schema,d=q(a.setupOnInit)?this.setupOnInit:a.setupOnInit;this.subs.autoInitSingletons=!0,n(this,{templateSrc:a.templateSrc||this.templateSrc,templateVars:o(a.templateVars||this.templateVars||{},{label:a.label}),setupOnInit:a.setupOnInit||this.setupOnInit,validateOnSet:q(a.validateOnSet)?this.validateOnSet:a.validateOnSet,twoWay:q(a.twoWay)?this.twoWay:a.twoWay,autoUpdateModel:q(a.autoUpdateModel)?this.autoUpdateModel:a.autoUpdateModel,fieldsWrapper:a.fieldsWrapper||this.fieldsWrapper}),this.template=a.template||(this.templateSrc?c.template(this.templateSrc):this.template),this.subViewConfig=a.subViewConfig||null,b&&(this.setSchema(b),d&&this.setupFields())},setSchema:function(a){return this.schema=a||this.schema,this},setupFields:function(){return this.subViewConfig=this._setupSubViewConfig(t(this,"schema")),this.subs.addConfig(this.subViewConfig),this._hasSetupFields=!0,this},setModelAttrs:function(){return this.subs.each(function(a){r(a.setModelAttrs)&&a.setModelAttrs()}),this},getFieldsWrapper:function(){var a=this.$(this.fieldsWrapper);return a.length?a.first():this.$el},render:function(){var a=this.options.fieldOrder||this.fieldOrder;if(this.subs.detachElems(),this._hasSetupFields||this.setupFields(),this.$el.html(this.template(this.templateVars)),a&&a.length)for(a=a.slice(0);a.length;)this.subs.renderByKey(a.shift(),{useLocation:!0});else this.subs.renderAppend();return this},_setupSubViewConfig:function(a,b,c){var d,e,f,g=this,h={};return b=b||this.model,c=c||this.collection,m(a,function(a,i){f=h[i]=p(a),f.options=r(a.options)?a.options.call(this):p(a.options||{}),d=f.options=f.options||{},f.singleton=void 0===f.singleton?!0:f.singleton,f.construct=g.fieldAlias[f.type||f.construct]||f.type||f.construct,f.location=f.location||g.fieldsWrapper,d.model=x(d.model,i,b),this.validateOnSet&&(d.setOpts=o(d.setOpts||{},{validate:!0})),this.twoWay&&(d.twoWay=q(d.twoWay)?this.twoWay:d.twoWay),e=y(d.collection,i,b,c),e&&(d.collection=e),d.schema&&(d.subViewConfig=g._setupSubViewConfig(d.schema,d.model)),d.schemaKey=i},this),h}},{addFieldAlias:function(a,c){var d={},e=b.FormView.prototype.fieldAlias;c?d[a]=c:d=a,o(e,d)}}),n(b.FormView.prototype,u),b.CollectionFormRowView=b.FormView.extend({className:"form-field-row controls-row",tagName:"div",getFieldPrefix:function(){var a="";return this.parentView&&this.parentView.getFieldPrefix&&(a=this.parentView.getFieldPrefix(this)||""),a+this.options.index+"-"},deleteSelf:function(){return this.parentView.deleteRow(this),this}}),b.CollectionFormView=b.BaseView.extend({tagName:"form",className:"form",rowTemplateSrc:"",rowWrapper:"[data-rows]:first",template:c.template('<div data-rows=""></div>'),initialize:function(a){if(this.options=o(a||{},this.options),this.templateSrc=q(this.options.templateSrc)?this.templateSrc:this.options.templateSrc,this.template=this.options.template||(this.templateSrc?c.template(this.templateSrc):this.template),this.setupOnInit=q(this.options.setupOnInit)?this.setupOnInit:this.options.setupOnInit,this.rowOptions=this.options.rowOptions||this.rowOptions,this.templateVars=o(this.options.templateVars||{},{label:this.options.label}),this.rowWrapper=this.options.rowWrapper||this.rowWrapper,this.options.rowConfig)this.rowConfig=this.options.rowConfig,this.rowConfig=t(this,"rowConfig");else{this.rowConfig=t(this,"rowConfig")||{singleton:!1,construct:b.CollectionFormRowView};var d=n({},t(this,"rowOptions"),{schema:this.options.rowSchema||this.rowSchema||(this.rowConfig&&this.rowConfig.options?this.rowConfig.options.schema:null)});this.rowConfig.options=d}this.subs.addConfig("row",this.rowConfig),this.setupOnInit&&this.setupRows()},setRowSchema:function(a){return this.rowConfig.options||(this.rowConfig.options={}),this.rowConfig.options.schema=a||this.options.rowSchema||this.rowSchema,this},render:function(){return this.subs.detachElems(),this.$el.html(this.template(this.templateVars)),this.subs.get("row")&&this.subs.get("row").length||this.setupRows(),this.subs.renderByKey("row",{appendTo:this.getRowWrapper()}),this},getRowWrapper:function(){var a=this.$(this.rowWrapper);return a.length?a.first():this.$el},addRow:function(a){var c;return a=a||new this.collection.model,s(a)||(a=[a]),c=this.collection.add(a),c instanceof b.Collection||(a=c),m(a,function(a){this._addRow(a).subs.last().render().$el.appendTo(this.getRowWrapper())},this),this},deleteRow:function(a){var c=a instanceof k?a:null,d=!c&&a instanceof b.View?a:null,e=c||d||!s(a)?null:a;return e?(m(e,this.deleteRow,this),this):(d?c||(c=d.model):d=this.subs.get(c),this.subs.remove(d),this.collection.remove(c),this)},reset:function(){return this.setupRows().subs.renderByKey("row",{appendTo:this.getRowWrapper()}),this},setupRows:function(){return this.subs.remove("row"),this.collection.each(this._addRow,this),this},_addRow:function(a){var b=this.subs.add("row",this._getRowOptions(a)).last();return b.setSchema(this.rowSchema).setupFields(),this},_getRowOptions:function(a){return{model:a,index:this.subViews.length}}}),n(b.CollectionFormView.prototype,u),b.formTemplates=b.formTemplates||{},b.formTemplates.Field='<% if (obj.label) { %><label class="control-label" <% if (obj.inputId) { %> for="<%= obj.inputId %>" <% } %> ><%= obj.label %></label><% } %><div class="controls" data-input=""></div><div class="controls"><div class="text-error" data-error=""></div><% if (obj.help) { %><span class="help-block"><%= obj.help %></span><% } %></div>',b.fields=b.fields||{},d=b.fields.FieldView=b.BaseView.extend({tagName:"div",classDefaults:"control-group form-field",inputPrefix:"field-input-",fieldPrefix:"form-field-",template:c.template(b.formTemplates.Field),addId:!0,elementType:"input",inputWrapper:"[data-input]:first",disabledDataKey:"formViewDisabled",events:function(){var a={};return a["blur "+this.elementType]="setModelAttrs",a},initialize:function(a){a=this.options=o(a||{},this.options),n(this,{templateVars:a.templateVars||this.templateVars||{},fieldName:a.fieldName||a.schemaKey,elementType:a.elementType||this.elementType,templateSrc:q(a.templateSrc)?this.templateSrc:a.templateSrc,template:a.template||this.template,setOpts:o(a.setOpts||{},this.setOpts),twoWay:q(a.twoWay)?this.twoWay:a.twoWay,inputAttrs:a.inputAttrs||this.inputAttrs,placeholder:a.placeholder||this.placeholder,inputClass:a.inputClass||this.inputClass,addId:q(a.addId)?this.addId:a.addId,inputWrapper:a.inputWrapper||this.inputWrapper}),n(this.templateVars,{inputId:this.addId?this._getInputId():!1,help:a.help,fieldName:this.fieldName,label:a.label}),this.template=this.templateSrc?c.template(this.templateSrc):this.template,a.className&&this.className||this.$el.addClass(this.fieldPrefix+this.fieldName),this.$el.addClass(this.classDefaults).attr("data-field",""),this.twoWay&&this.setupTwoWay&&this.setupTwoWay()},setupTwoWay:function(){return this.listenTo(this.model,"change:"+this.fieldName,function(){this._viewChangedModel||this.renderInput(),this._viewChangedModel=!1}),this},getAttrs:function(){var a={};return a[this.fieldName]=this.getValue(),a},setModelAttrs:function(){return this._viewChangedModel=!0,this.model.set(this.getAttrs(),this.setOpts)||(this._viewChangedModel=!1),this},getValue:function(){return b.$.trim(this.$(this.elementType).val())},getModelVal:function(){return this.model.get(this.fieldName)},render:function(){return this.renderWrapper().renderInput()},renderWrapper:function(a){return this.$el.html(this.template(a||this.templateVars)),this},renderInput:function(){var a,c=this.templateVars.inputId,d=this.addId?{id:c,name:c}:{},e=this.getModelVal();return a=b.$("<"+this.elementType+">"),"input"===this.elementType&&(d.type="text"),this.placeholder&&(d.placeholder=this.placeholder),a.attr(o(d,this.inputAttrs)),this.inputClass&&a.addClass(this.inputClass),this.getInputWrapper().html(a),e&&a.val(e),this},getInputWrapper:function(){var a=this.$(this.inputWrapper);return a.length?a.first():this.$el},disable:function(){return this.$(this.elementType).prop("disabled",!0),this.isDisabled=!0,this},enable:function(){return this.$(this.elementType).prop("disabled",!1),this.isDisabled=!1,this},_getInputId:function(){return this.options.inputId||this.inputId||this.inputPrefix+this._getParentPrefix()+this.fieldName},_getParentPrefix:function(){return this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix(this)||"":""}},{setDefaultFieldTemplate:function(a){d.prototype.template=a}}),e=b.fields.RadioListView=b.fields.FieldView.extend({tagName:"div",events:function(){var a={};return a["click "+this.elementType]="setModelAttrs",a},type:"radio-list",initialize:function(a){a=this.options=o(a||{},this.options),this.possibleVals=a.possibleVals||this.possibleVals||{},this.labelAttrs=a.labelAttrs||this.labelAttrs,e.__super__.initialize.call(this,a)},getValue:function(){return this.$(this.elementType+":checked").val()},isSelected:function(a){return this.getModelVal()+""==""+a},renderInput:function(){var a,c,d,e,f=t(this,"possibleVals"),g=0,h=this,i=this.templateVars.inputId,j=this.getInputWrapper().empty(),k=o(this.labelAttrs||{},{"class":"radio"}),l=function(a,c,d){var e,f,j={type:"radio",value:c};return h.addId&&n(j,{name:i,id:i+"-"+g}),d&&(j.checked="checked"),e=b.$("<input>").attr(o(j,h.inputAttrs)),h.inputClass&&e.addClass(h.inputClass),f=b.$("<label>").attr(k),f.append(e).append(a),f};for(a in f)f.hasOwnProperty(a)&&(c=this._parsePossibleVal(f,a),e=this.isSelected(c.value),d=l(c.display,c.value,e),j.append(d),g++);return this},_parsePossibleVal:function(a,b){var c=a[b];return c&&c.value&&c.display?c:a.slice&&s(a)?{value:c,display:c}:(b&&!isNaN(Number(b))&&(b=Number(b)),{value:b,display:c})}}),f=b.fields.SelectListView=b.fields.RadioListView.extend({type:"select-list",elementType:"select",events:function(){var a={};return a["change "+this.elementType]="setModelAttrs",a},initialize:function(a){a=this.options=o(a||{},this.options),this.multiple=q(a.multiple)?this.multiple:a.multiple,f.__super__.initialize.call(this,a)},getValue:function(){return this.$(this.elementType).val()},isSelected:function(a){var b=this.getModelVal();return b=this.multiple?b:[b],-1!==c.indexOf(c.map(b,String),a+"")},renderInput:function(){var a=t(this,"possibleVals"),c=this.templateVars.inputId,d=b.$("<"+this.elementType+">").attr(o(this.addId?{id:c,name:c}:{},this.inputAttrs));return this.getInputWrapper().html(d),this.multiple&&d.attr("multiple","multiple"),this.inputClass&&d.addClass(this.inputClass),this.placeholder&&d.append('<option value="">'+this.placeholder+"</option>"),this._renderInput(d,a)},_renderInput:function(a,c){var d,e,f,g;for(d in c)c.hasOwnProperty(d)&&(e=this._parsePossibleVal(c,d),e.group?(f=b.$('<optgroup label="'+d+'"></optgroup>').appendTo(a),this._renderInput(f,e.group)):(g=b.$("<option>").text(e.display).attr("value",e.value),this.isSelected(e.value)&&g.prop("selected",!0),g.appendTo(a)));return this},_parsePossibleVal:function(a,b){var d=a[b];return d&&d.group&&d.display?d:c.isObject(d)&&!s(a)?{group:d,display:b}:f.__super__._parsePossibleVal.call(this,a,b)}}),g=b.fields.CheckListView=b.fields.RadioListView.extend({tagName:"div",type:"check-list",checkedVal:!0,unCheckedVal:!1,initialize:function(a){a=this.options=o(a||{},this.options),this.checkedVal=a.checkedVal||this.checkedVal,this.unCheckedVal=a.unCheckedVal||this.unCheckedVal,g.__super__.initialize.call(this,a)},setupTwoWay:function(){var a=t(this,"possibleVals");m(a,function(b,c){var d=this._parsePossibleVal(a,c);this.listenTo(this.model,"change:"+d.value,function(){this._viewChangedModel||this.renderInput(),this._viewChangedModel=!1})},this)},getAttrs:function(){var a={},c=this;return this.$(this.elementType).each(function(d,e){var f=b.$(e),g=f.val(),h=f.prop("checked")?c.checkedVal:c.unCheckedVal;(h===c.checkedVal||c.isSelected(g))&&(a[g]=h)}),a},getModelVal:function(a){return this.model.get(a)},renderSingleCheckbox:function(a,c,d,e){var f,g,h=this.templateVars.inputId,i={type:"checkbox",value:a};return this.addId&&n(i,{name:h,id:h+"-"+e}),d&&(i.checked="checked"),f=b.$("<input>").attr(o(i,this.inputAttrs)),this.inputClass&&f.addClass(this.inputClass),g=b.$("<label>").attr(o(this.labelAttrs||{},{"class":"checkbox"})),g.append(f).append(c)},isSelected:function(a){return this.getModelVal(a)===this.checkedVal},renderInput:function(){var a,b,c,d,e=t(this,"possibleVals"),f=0,g=this.getInputWrapper().empty();for(a in e)e.hasOwnProperty(a)&&(b=this._parsePossibleVal(e,a),d=this.isSelected(b.value),c=this.renderSingleCheckbox(b.value,b.display,d,f),g.append(c),f++);return this}}),h=b.fields.CheckBoxView=b.fields.FieldView.extend({checkedVal:!0,unCheckedVal:!1,events:function(){var a={};return a["click "+this.elementType]="setModelAttrs",a},initialize:function(a){a=this.options=o(a||{},this.options),this.checkedVal=a.checkedVal||this.checkedVal,this.unCheckedVal=a.unCheckedVal||this.unCheckedVal,this.displayText=a.displayText||this.displayText,this.labelAttrs=a.labelAttrs||this.labelAttrs,h.__super__.initialize.call(this,a)},getValue:function(){return this.$(this.elementType).prop("checked")?this.checkedVal:this.unCheckedVal},isSelected:function(){return this.getModelVal()===this.checkedVal},renderInput:function(){var a=b.$("<label>").attr(o(this.labelAttrs||{},{"class":"checkbox"})),c=b.$("<input>").attr({type:"checkbox",value:this.checkedVal}),d=this.templateVars.inputId;return this.addId&&c.attr({id:d,name:d}),this.isSelected()&&c.prop("checked",!0),a.append(c),this.displayText&&a.append(this.displayText),this.getInputWrapper().html(a),this.inputClass&&c.addClass(this.inputClass),this}}),i=b.FieldSetView=b.FormView.extend({tagName:"div",setupOnInit:!0,className:"",initialize:function(a){a=this.options=o(a||{},this.options),this.fieldSetName=a.fieldSetName||this.fieldSetName||a.schemaKey,i.__super__.initialize.call(this,a),this.$el.addClass(this.className||"fieldset fieldset-"+this.fieldSetName)},getFieldPrefix:v,templateSrc:'<% if(obj && obj.label) { %><label class="fieldset-label"><strong><%= obj.label %></strong></label><% } %><fieldset data-fields=""></fieldset>'}),j=b.CollectionFieldSetView=b.CollectionFormView.extend({tagName:"div",templateSrc:'<% if(obj && obj.label) { %><p><strong><%= obj.label %></strong></p><% } %><fieldset class="fieldset" data-rows=""></fieldset>',setupOnInit:!0,className:"",initialize:function(a){return a=this.options=o(a||{},this.options),this.fieldSetName=a.fieldSetName||this.fieldSetName||a.schemaKey,j.__super__.initialize.call(this,a),this.$el.addClass(this.className||"fieldset fieldset-"+this.fieldSetName),this},getFieldPrefix:v})}(this);