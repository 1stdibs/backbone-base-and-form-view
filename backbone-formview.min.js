//     Backbone.FormView 0.4.0
//     (c) 2013 James Ballantine, 1stdibs.com Inc.
//     Backbone.FormView may be freely distributed under the MIT license.
//     For all details and documentation:
//     https://github.com/1stdibs/backbone-base-and-form-view
!function(a){"use strict";var b=a.jQuery,c=a.Backbone,d=a._;if("undefined"!=typeof module&&(b=require("jquery").create(),d=require("underscore"),c=require("./backbone-baseview"),module.exports=c),!c||!c.BaseView)throw new Error("Backbone and Backbone.BaseView required");var e=c.Model,f=c.Collection,g=d.each,h=d.extend,i=d.defaults,j=d.clone,k=d.isUndefined,l=d.isFunction,m=d.isArray,n=d.result,o={disable:function(){return this.subs.each(function(a){l(a.disable)&&a.disable()}),this},enable:function(){return this.subs.each(function(a){l(a.enable)&&a.enable()}),this}},p=function(a,b,c){return a instanceof c?a:a===!0&&b instanceof c?b:b?(b=b.get(a),b instanceof c?b:null):null},q=function(a,b,c){return a?p(a,c,e)||c:p(b,c,e)||c},r=function(a,b,c,d){return a?p(a,c,f)||d:p(b,c,f)||null};c.FormView=c.BaseView.extend({tagName:"form",className:"form-horizontal",fieldAlias:{Text:"Backbone.fields.FieldView",RadioList:"Backbone.fields.RadioListView",CheckList:"Backbone.fields.CheckListView",Select:"Backbone.fields.SelectListView",FieldSet:"Backbone.FieldSetView",Checkbox:"Backbone.fields.CheckBoxView",CollectionField:"Backbone.CollectionFieldSetView"},templateSrc:'<div data-fields=""></div>',fieldsWrapper:"[data-fields]",initialize:function(a){a=this.options=i(a||{},this.options);var b=a.schema||this.schema,c=k(a.setupOnInit)?this.setupOnInit:a.setupOnInit;this.subs.autoInitSingletons=!0,h(this,{templateSrc:a.templateSrc||this.templateSrc,templateVars:i(a.templateVars||this.templateVars||{},{label:a.label}),setupOnInit:a.setupOnInit||this.setupOnInit,validateOnSet:k(a.validateOnSet)?this.validateOnSet:a.validateOnSet,twoWay:k(a.twoWay)?this.twoWay:a.twoWay,autoUpdateModel:k(a.autoUpdateModel)?this.autoUpdateModel:a.autoUpdateModel}),this.template=a.template||d.template(this.templateSrc),this.subViewConfig=a.subViewConfig||null,b&&(this.setSchema(b),c&&this.setupFields()),this.autoUpdateModel&&this._setupAutoUpdate()},setSchema:function(a){return this.schema=a||this.schema,this},setupFields:function(){return this.subViewConfig=this._setupSubViewConfig(n(this,"schema")),this.subs.addConfig(this.subViewConfig),this},setModelAttrs:function(){return this.subs.invoke("setModelAttrs"),this},getFieldsWrapper:function(){var a=this.$(this.fieldsWrapper);return a.length?a:this.$el},render:function(){var a=this.options.fieldOrder||this.fieldOrder;if(this.subViewConfig||this.setupFields(),this.$el.html(this.template(this.templateVars)),a&&a.length)for(a=a.slice(0);a.length;)this.subs.renderByKey(a.shift());else this.subs.renderAppend();return this},resetModels:function(){var a,b,d,e,g,h,i,j=0,k=this.subViews,l=k.length;for(j;l>j;j++)h=!1,e=this.subs.getSubViewType(k[j]),g=this.schema[e].options||{},a=k[j].model,b=q(g.model,e,this.model),a&&b&&b.cid!==a.cid&&(k[j].model=b,i=this.subs._subViewsByModelCid,i[b.cid]?m(i[b.cid])?i[b.cid].push(k[j]):i[b.cid]=[i[b.cid],k[j]]:i[b.cid]=k[j],h=!0),d=r(g.collection,e,this.model,this.collection),d&&k[j].collection instanceof f&&k[j].collection!==d&&(k[j].collection=d,h=!0),h&&k[j]instanceof c.BaseView&&k[j].bindViewEvents(),k[j]instanceof c.FormView&&k[j]._resetModels();return this},_setupSubViewConfig:function(a,b,c){var d,e,f,h=this,m={};return b=b||this.model,c=c||this.collection,g(a,function(a,g){f=m[g]=j(a),f.options=l(a.options)?a.options.call(this):j(a.options||{}),d=f.options=f.options||{},f.singleton=void 0===f.singleton?!0:f.singleton,f.construct=h.fieldAlias[f.type||f.construct]||f.type||f.construct,f.location=f.location||h.fieldsWrapper,d.model=q(d.model,g,b),this.validateOnSet&&(d.setOpts=i(d.setOpts||{},{validate:!0})),this.twoWay&&(d.twoWay=k(d.twoWay)?this.twoWay:d.twoWay),e=r(d.collection,g,b,c),e&&(d.collection=e),d.schema&&(d.subViewConfig=h._setupSubViewConfig(d.schema,d.model)),d.schemaKey=g},this),m},_setupAutoUpdate:function(){return this.model.on("change",function(a){g(a,function(a){a instanceof e&&this.resetModels()},this)},this),this}},{addFieldAlias:function(a,b){var d={},e=c.FormView.prototype.fieldAlias;b?d[a]=b:d=a,i(e,d)}}),h(c.FormView.prototype,o),c.CollectionFormRowView=c.FormView.extend({className:"form-field-row controls-row",tagName:"div",getFieldPrefix:function(){var a="";return this.parentView&&this.parentView.getFieldPrefix&&(a=this.parentView.getFieldPrefix(this)||""),a+this.options.index+"-"}}),c.CollectionFormView=c.BaseView.extend({tagName:"form",attributes:{"class":"form"},rowTemplateSrc:"",rowConfig:{singleton:!1,construct:c.CollectionFormRowView},initialize:function(a){if(this.options=i(a||{},this.options),this.templateSrc=k(this.options.templateSrc)?this.templateSrc:this.options.templateSrc,this.template=this.options.template||this.template||d.template(this.templateSrc||""),this.setupOnInit=k(this.options.setupOnInit)?this.setupOnInit:this.options.setupOnInit,this.rowOptions=this.options.rowOptions||this.rowOptions,this.templateVars=i(this.options.templateVars||{},{label:this.options.label}),this.options.rowConfig)this.rowConfig=this.options.rowConfig,this.rowConfig=n(this,"rowConfig");else{var b=h({},n(this,"rowOptions"),{schema:this.options.rowSchema||this.rowSchema||(this.rowConfig&&this.rowConfig.options?this.rowConfig.options.schema:null)});this.rowConfig.options=b}this.subs.addConfig("row",this.rowConfig),this.setupOnInit&&this.setupRows()},setRowSchema:function(a){return this.rowConfig.rowSchema=a||this.options.rowSchema||this.rowSchema,this},render:function(){return this.$el.html(this.template(this.templateVars)),this.subs.get("row")&&this.subs.get("row").length||this.setupRows(),this.subs.renderByKey("row",{appendTo:this.getRowWrapper()}),this},getRowWrapper:function(){var a=this.$("[data-rows]");return a.length?a:this.$el},addRow:function(a){return a=a||new this.collection.model,m(a)||(a=[a]),this.collection.add(a),g(a,function(a){this._addRow(a).subs.last().render().$el.appendTo(this.getRowWrapper())},this),this},deleteRow:function(a){var b=a instanceof e?a:null,d=!b&&a instanceof c.View?a:null,f=b||d||!m(a)?null:a;return f?(g(f,this.deleteRow,this),this):(d?b||(b=d.model):d=this.subs.get(b),this.subs.remove(d),this.collection.remove(b),this)},setupRows:function(){return this.subs.remove("row"),this.collection.each(this._addRow,this),this},_addRow:function(a){var b=this.subs.add("row",this._getRowOptions(a)).last();return b.setSchema(this.rowSchema).setupFields(),this},_getRowOptions:function(a){return{model:a,index:this.subViews.length}}}),h(c.CollectionFormView.prototype,o),c.formTemplates=c.formTemplates||{},c.formTemplates.Field='<% if (obj.label) { %><label class="control-label" <% if (obj.inputId) { %> for="<%= obj.inputId %>" <% } %> ><%= obj.label %></label><% } %><div class="controls" data-input=""></div><div class="controls"><div class="text-error" data-error=""></div><% if (obj.help) { %><span class="help-block"><%= obj.help %></span><% } %></div>',c.fields=c.fields||{},c.fields.FieldView=c.BaseView.extend({tagName:"div",classDefaults:"control-group form-field",inputPrefix:"field-input-",fieldPrefix:"form-field-",template:d.template(c.formTemplates.Field),addId:!0,elementType:"input",events:function(){var a={};return a["blur "+this.elementType]="setModelAttrs",a},initialize:function(a){a=this.options=i(a||{},this.options),h(this,{templateVars:a.templateVars||{},fieldName:a.fieldName||a.schemaKey,elementType:a.elementType||this.elementType,templateSrc:k(a.templateSrc)?this.templateSrc:a.templateSrc,template:a.template||this.template,setOpts:i(a.setOpts||{},this.setOpts),twoWay:k(a.twoWay)?this.twoWay:a.twoWay,inputAttrs:a.inputAttrs||this.inputAttrs,placeholder:a.placeholder||this.placeholder,inputClass:a.inputClass||this.inputClass,addId:k(a.addId)?this.addId:a.addId}),h(this.templateVars,{inputId:this.addId?this._getInputId():!1,help:a.help,fieldName:this.fieldName,label:a.label}),this.template=this.templateSrc?d.template(this.templateSrc):this.template,a.className&&this.className||this.$el.addClass(this.fieldPrefix+this.fieldName),this.$el.addClass(this.classDefaults).attr("data-field",""),this.twoWay&&this.setupTwoWay&&this.setupTwoWay()},setupTwoWay:function(){return this.listenTo(this.model,"change:"+this.fieldName,function(){this._viewChangedModel||this.renderInput(),this._viewChangedModel=!1}),this},getAttrs:function(){var a={};return a[this.fieldName]=this.getValue(),a},setModelAttrs:function(){return this._viewChangedModel=!0,this.model.set(this.getAttrs(),this.setOpts)||(this._viewChangedModel=!1),this},getValue:function(){return b.trim(this.$(this.elementType).val())},getModelVal:function(){return this.model.get(this.fieldName)},render:function(){return this.renderWrapper().renderInput()},renderWrapper:function(a){return this.$el.html(this.template(a||this.templateVars)),this},renderInput:function(){var a,c=this.templateVars.inputId,d=this.addId?{id:c,name:c}:{},e=this.getModelVal();return a=b("<"+this.elementType+">"),"input"===this.elementType&&(d.type="text"),this.placeholder&&(d.placeholder=this.placeholder),a.attr(i(d,this.inputAttrs)),this.inputClass&&a.addClass(this.inputClass),this.getInputWrapper().html(a),e&&a.val(e),this},getInputWrapper:function(){var a=this.$("[data-input]");return a.length?a:this.$el},disable:function(){var a=this.$(this.elementType);return this.isDisabled||a.attr("disabled")||(a.attr("disabled",!0),this.isDisabled=!0),this},enable:function(){return this.isDisabled&&(this.$(this.elementType).removeAttr("disabled"),this.isDisabled=!1),this},_getInputId:function(){return this.options.inputId||this.inputId||this.inputPrefix+this._getParentPrefix()+this.fieldName},_getParentPrefix:function(){return this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix(this)||"":""}}),c.fields.RadioListView=c.fields.FieldView.extend({tagName:"div",events:{"click input:radio":"setModelAttrs"},type:"radio-list",initialize:function(a){a=a||{},this.possibleVals=a.possibleVals||this.possibleVals||{},c.fields.RadioListView.__super__.initialize.call(this,a)},getValue:function(){return this.$(this.elementType+":checked").val()},renderInput:function(){var a,c=n(this,"possibleVals"),d=0,e=this,f=this.templateVars.inputId,g=this.getModelVal(),j=this.getInputWrapper().empty(),k=function(c,g){var j,k,l={type:"radio",value:a};return e.addId&&h(l,{name:f,id:f+"-"+d}),g&&(l.checked="checked"),j=b("<input>").attr(i(l,e.inputAttrs)),e.inputClass&&j.addClass(e.inputClass),k=b("<label>").attr("class","radio"),k.append(j).append(c),k};for(a in c)c.hasOwnProperty(a)&&(isNaN(Number(a))||(a=Number(a)),j.append(k(c[a],g+""==""+a)),d++);return this}}),c.fields.SelectListView=c.fields.RadioListView.extend({type:"select-list",elementType:"select",events:function(){var a={};return a["change "+this.elementType]="setModelAttrs",a},initialize:function(a){a=a||{},this.multiple=k(a.multiple)?this.multiple:a.multiple,c.fields.SelectListView.__super__.initialize.call(this,a)},getValue:function(){return this.$(this.elementType).val()},renderInput:function(){var a=n(this,"possibleVals"),c=this.getModelVal(),d=this.templateVars.inputId,e=b("<"+this.elementType+">").attr(i(this.addId?{id:d,name:d}:{},this.inputAttrs));return this.getInputWrapper().html(e),this.multiple&&e.attr("multiple","multiple"),this.inputClass&&e.addClass(this.inputClass),this.placeholder&&e.append('<option value="">'+this.placeholder+"</option>"),this._renderInput(e,a,c)},_renderInput:function(a,c,e){var f,g,h,i,j=function(a){return""+a},k=m(c);e=d.map(m(e)?e:[e],j);for(f in c)c.hasOwnProperty(f)&&(g=c[f],d.isObject(g)?(h=b('<optgroup label="'+f+'"></optgroup>').appendTo(a),this._renderInput(h,c[f],e)):(i=b("<option>").text(c[f]),k||(g=f,i.attr("value",f)),-1!==d.indexOf(e,j(g))&&i.attr("selected","selected"),i.appendTo(a)))}}),c.fields.CheckListView=c.fields.FieldView.extend({tagName:"div",type:"check-list",checkedVal:!0,unCheckedVal:!1,initialize:function(a){a=a||{},this.possibleVals=a.possibleVals||this.possibleVals||{},this.checkedVal=a.checkedVal||this.checkedVal,this.unCheckedVal=a.unCheckedVal||this.unCheckedVal,c.fields.CheckListView.__super__.initialize.call(this,a)},setupTwoWay:function(){g(n(this,"possibleVals"),function(a,b){this.listenTo(this.model,"change:"+b,function(){this._viewChangedModel||this.renderInput(),this._viewChangedModel=!1})},this)},setModelAttrs:function(a){var c={},d=b(a.target),e=d.val();c[e]=d.is(":checked")?this.checkedVal:this.unCheckedVal,this.model.set(c,this.setOpts)},renderInput:function(){var a,c,d=n(this,"possibleVals"),e=0,f=this.templateVars.inputId,g=this,j=this.getInputWrapper().empty(),k=function(a,d,j){var k,l;return c={type:"checkbox",value:a},this.addId&&h(c,{name:f,id:f+"-"+e}),j&&(c.checked="checked"),k=b("<input>").attr(i(c,g.inputAttrs)),g.inputClass&&k.addClass(g.inputClass),l=b("<label>").attr("class","checkbox"),l.append(k).append(d)};for(a in d)d.hasOwnProperty(a)&&(j.append(k(a,d[a],g.model.get(a)===g.checkedVal)),e++);return this}}),c.fields.CheckBoxView=c.fields.FieldView.extend({checkedVal:!0,unCheckedVal:!1,initialize:function(a){a=a||{},this.checkedVal=a.checkedVal||this.checkedVal,this.unCheckedVal=a.unCheckedVal||this.unCheckedVal,this.displayText=a.displayText||this.displayText,c.fields.CheckListView.__super__.initialize.call(this,a)},getValue:function(){return this.$("input:checkbox").prop("checked")?this.checkedVal:this.unCheckedVal},renderInput:function(){var a=b("<label>").attr("class","checkbox"),c=b("<input>").attr({type:"checkbox",value:this.checkedVal}),d=this.templateVars.inputId,e=this.getModelVal();return this.addId&&c.attr({id:d,name:d}),(e===!0||e===this.checkedVal)&&c.attr("checked","checked"),a.append(c),this.displayText&&a.append(this.displayText),this.getInputWrapper().html(a),this.inputClass&&c.addClass(this.inputClass),this}}),c.FieldSetView=c.FormView.extend({tagName:"div",className:"fieldset",setupOnInit:!0,initialize:function(a){a=a||{},this.fieldSetName=a.fieldSetName||this.fieldSetName||a.schemaKey,c.FieldSetView.__super__.initialize.call(this,a),this.$el.addClass("fieldset-"+this.fieldSetName)},getFieldPrefix:function(){var a=this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix():"";return a+this.fieldSetName+"-"},templateSrc:'<% if(obj && obj.label) { %><label class="fieldset-label"><strong><%= obj.label %></strong></label><% } %><fieldset data-fields=""></fieldset>'}),c.CollectionFieldSetView=c.CollectionFormView.extend({tagName:"div",className:"fieldset",templateSrc:'<% if(obj && obj.label) { %><p><strong><%= obj.label %></strong></p><% } %><fieldset class="fieldset" data-rows=""></fieldset>',setupOnInit:!0,initialize:function(a){return a=a||{},this.fieldSetName=a.fieldSetName||this.fieldSetName||a.schemaKey,c.CollectionFieldSetView.__super__.initialize.call(this,a),this.$el.addClass("fieldset-"+this.fieldSetName),this},getFieldPrefix:function(){var a=this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix():"";return a+this.fieldSetName+"-"}})}(this);