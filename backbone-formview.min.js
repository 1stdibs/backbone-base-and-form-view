//     Backbone.FormView 0.4.0
//     (c) 2013 James Ballantine, 1stdibs.com Inc.
//     Backbone.FormView may be freely distributed under the MIT license.
//     For all details and documentation:
//     https://github.com/1stdibs/backbone-base-and-form-view
!function(a,b,c){"use strict";if(!b||!b.BaseView)throw new Error("Backbone and Backbone.BaseView required");var d=b.Model,e=b.Collection,f=c.each,g=c.extend,h=c.defaults,i=c.clone,j=c.isUndefined,k=c.isFunction,l=c.isArray,m=c.result,n={disable:function(){return this.subs.each(function(a){k(a.disable)&&a.disable()}),this},enable:function(){return this.subs.each(function(a){k(a.enable)&&a.enable()}),this}},o=function(){var a=this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix():"";return a+this.fieldSetName+"-"},p=function(a,b,c){return a instanceof c?a:a===!0&&b instanceof c?b:b?(b=b.get(a),b instanceof c?b:null):null},q=function(a,b,c){return a?p(a,c,d)||c:p(b,c,d)||c},r=function(a,b,c,d){return a?p(a,c,e)||d:p(b,c,e)||null};b.FormView=b.BaseView.extend({tagName:"form",className:"form-horizontal",fieldAlias:{Text:"Backbone.fields.FieldView",RadioList:"Backbone.fields.RadioListView",CheckList:"Backbone.fields.CheckListView",Select:"Backbone.fields.SelectListView",FieldSet:"Backbone.FieldSetView",Checkbox:"Backbone.fields.CheckBoxView",CollectionField:"Backbone.CollectionFieldSetView"},templateSrc:'<div data-fields=""></div>',fieldsWrapper:"[data-fields]:first",initialize:function(a){a=this.options=h(a||{},this.options);var b=a.schema||this.schema,d=j(a.setupOnInit)?this.setupOnInit:a.setupOnInit;this.subs.autoInitSingletons=!0,g(this,{templateSrc:a.templateSrc||this.templateSrc,templateVars:h(a.templateVars||this.templateVars||{},{label:a.label}),setupOnInit:a.setupOnInit||this.setupOnInit,validateOnSet:j(a.validateOnSet)?this.validateOnSet:a.validateOnSet,twoWay:j(a.twoWay)?this.twoWay:a.twoWay,autoUpdateModel:j(a.autoUpdateModel)?this.autoUpdateModel:a.autoUpdateModel,fieldsWrapper:a.fieldsWrapper||this.fieldsWrapper}),this.template=a.template||c.template(this.templateSrc),this.subViewConfig=a.subViewConfig||null,b&&(this.setSchema(b),d&&this.setupFields()),this.autoUpdateModel&&this._setupAutoUpdate()},setSchema:function(a){return this.schema=a||this.schema,this},setupFields:function(){return this.subViewConfig=this._setupSubViewConfig(m(this,"schema")),this.subs.addConfig(this.subViewConfig),this},setModelAttrs:function(){return this.subs.invoke("setModelAttrs"),this},getFieldsWrapper:function(){var a=this.$(this.fieldsWrapper);return a.length?a.first():this.$el},render:function(){var a=this.options.fieldOrder||this.fieldOrder;if(this.subViewConfig||this.setupFields(),this.$el.html(this.template(this.templateVars)),a&&a.length)for(a=a.slice(0);a.length;)this.subs.renderByKey(a.shift(),{useLocation:!0});else this.subs.renderAppend();return this},resetModels:function(){var a,c,d,f,g,h,i,j=0,k=this.subViews,m=k.length;for(j;m>j;j++)h=!1,f=this.subs.getSubViewType(k[j]),g=this.schema[f].options||{},a=k[j].model,c=q(g.model,f,this.model),a&&c&&c.cid!==a.cid&&(k[j].model=c,i=this.subs._subViewsByModelCid,i[c.cid]?l(i[c.cid])?i[c.cid].push(k[j]):i[c.cid]=[i[c.cid],k[j]]:i[c.cid]=k[j],h=!0),d=r(g.collection,f,this.model,this.collection),d&&k[j].collection instanceof e&&k[j].collection!==d&&(k[j].collection=d,h=!0),h&&k[j]instanceof b.BaseView&&k[j].bindViewEvents(),k[j]instanceof b.FormView&&k[j]._resetModels();return this},_setupSubViewConfig:function(a,b,c){var d,e,g,l=this,m={};return b=b||this.model,c=c||this.collection,f(a,function(a,f){g=m[f]=i(a),g.options=k(a.options)?a.options.call(this):i(a.options||{}),d=g.options=g.options||{},g.singleton=void 0===g.singleton?!0:g.singleton,g.construct=l.fieldAlias[g.type||g.construct]||g.type||g.construct,g.location=g.location||l.fieldsWrapper,d.model=q(d.model,f,b),this.validateOnSet&&(d.setOpts=h(d.setOpts||{},{validate:!0})),this.twoWay&&(d.twoWay=j(d.twoWay)?this.twoWay:d.twoWay),e=r(d.collection,f,b,c),e&&(d.collection=e),d.schema&&(d.subViewConfig=l._setupSubViewConfig(d.schema,d.model)),d.schemaKey=f},this),m},_setupAutoUpdate:function(){return this.model.on("change",function(a){f(a,function(a){a instanceof d&&this.resetModels()},this)},this),this}},{addFieldAlias:function(a,c){var d={},e=b.FormView.prototype.fieldAlias;c?d[a]=c:d=a,h(e,d)}}),g(b.FormView.prototype,n),b.CollectionFormRowView=b.FormView.extend({className:"form-field-row controls-row",tagName:"div",getFieldPrefix:function(){var a="";return this.parentView&&this.parentView.getFieldPrefix&&(a=this.parentView.getFieldPrefix(this)||""),a+this.options.index+"-"}}),b.CollectionFormView=b.BaseView.extend({tagName:"form",className:"form",rowTemplateSrc:"",rowWrapper:"[data-rows]:first",rowConfig:{singleton:!1,construct:b.CollectionFormRowView},initialize:function(a){if(this.options=h(a||{},this.options),this.templateSrc=j(this.options.templateSrc)?this.templateSrc:this.options.templateSrc,this.template=this.options.template||this.template||c.template(this.templateSrc||""),this.setupOnInit=j(this.options.setupOnInit)?this.setupOnInit:this.options.setupOnInit,this.rowOptions=this.options.rowOptions||this.rowOptions,this.templateVars=h(this.options.templateVars||{},{label:this.options.label}),this.rowWrapper=a.rowWrapper||this.rowWrapper,this.options.rowConfig)this.rowConfig=this.options.rowConfig,this.rowConfig=m(this,"rowConfig");else{var b=g({},m(this,"rowOptions"),{schema:this.options.rowSchema||this.rowSchema||(this.rowConfig&&this.rowConfig.options?this.rowConfig.options.schema:null)});this.rowConfig.options=b}this.subs.addConfig("row",this.rowConfig),this.setupOnInit&&this.setupRows()},setRowSchema:function(a){return this.rowConfig.options||(this.rowConfig.options={}),this.rowConfig.options.schema=a||this.options.rowSchema||this.rowSchema,this},render:function(){return this.$el.html(this.template(this.templateVars)),this.subs.get("row")&&this.subs.get("row").length||this.setupRows(),this.subs.renderByKey("row",{appendTo:this.getRowWrapper()}),this},getRowWrapper:function(){var a=this.$(this.rowWrapper);return a.length?a.first():this.$el},addRow:function(a){var c;return a=a||new this.collection.model,l(a)||(a=[a]),c=this.collection.add(a),c instanceof b.Collection||(a=c),f(a,function(a){this._addRow(a).subs.last().render().$el.appendTo(this.getRowWrapper())},this),this},deleteRow:function(a){var c=a instanceof d?a:null,e=!c&&a instanceof b.View?a:null,g=c||e||!l(a)?null:a;return g?(f(g,this.deleteRow,this),this):(e?c||(c=e.model):e=this.subs.get(c),this.subs.remove(e),this.collection.remove(c),this)},reset:function(){return this.setupRows().subs.renderByKey("row",{appendTo:this.getRowWrapper()}),this},setupRows:function(){return this.subs.remove("row"),this.collection.each(this._addRow,this),this},_addRow:function(a){var b=this.subs.add("row",this._getRowOptions(a)).last();return b.setSchema(this.rowSchema).setupFields(),this},_getRowOptions:function(a){return{model:a,index:this.subViews.length}}}),g(b.CollectionFormView.prototype,n),b.formTemplates=b.formTemplates||{},b.formTemplates.Field='<% if (obj.label) { %><label class="control-label" <% if (obj.inputId) { %> for="<%= obj.inputId %>" <% } %> ><%= obj.label %></label><% } %><div class="controls" data-input=""></div><div class="controls"><div class="text-error" data-error=""></div><% if (obj.help) { %><span class="help-block"><%= obj.help %></span><% } %></div>',b.fields=b.fields||{},b.fields.FieldView=b.BaseView.extend({tagName:"div",classDefaults:"control-group form-field",inputPrefix:"field-input-",fieldPrefix:"form-field-",template:c.template(b.formTemplates.Field),addId:!0,elementType:"input",inputWrapper:"[data-input]:first",events:function(){var a={};return a["blur "+this.elementType]="setModelAttrs",a},initialize:function(a){a=this.options=h(a||{},this.options),g(this,{templateVars:a.templateVars||this.templateVars||{},fieldName:a.fieldName||a.schemaKey,elementType:a.elementType||this.elementType,templateSrc:j(a.templateSrc)?this.templateSrc:a.templateSrc,template:a.template||this.template,setOpts:h(a.setOpts||{},this.setOpts),twoWay:j(a.twoWay)?this.twoWay:a.twoWay,inputAttrs:a.inputAttrs||this.inputAttrs,placeholder:a.placeholder||this.placeholder,inputClass:a.inputClass||this.inputClass,addId:j(a.addId)?this.addId:a.addId,inputWrapper:a.inputWrapper||this.inputWrapper}),g(this.templateVars,{inputId:this.addId?this._getInputId():!1,help:a.help,fieldName:this.fieldName,label:a.label}),this.template=this.templateSrc?c.template(this.templateSrc):this.template,a.className&&this.className||this.$el.addClass(this.fieldPrefix+this.fieldName),this.$el.addClass(this.classDefaults).attr("data-field",""),this.twoWay&&this.setupTwoWay&&this.setupTwoWay()},setupTwoWay:function(){return this.listenTo(this.model,"change:"+this.fieldName,function(){this._viewChangedModel||this.renderInput(),this._viewChangedModel=!1}),this},getAttrs:function(){var a={};return a[this.fieldName]=this.getValue(),a},setModelAttrs:function(){return this._viewChangedModel=!0,this.model.set(this.getAttrs(),this.setOpts)||(this._viewChangedModel=!1),this},getValue:function(){return a.trim(this.$(this.elementType).val())},getModelVal:function(){return this.model.get(this.fieldName)},render:function(){return this.renderWrapper().renderInput()},renderWrapper:function(a){return this.$el.html(this.template(a||this.templateVars)),this},renderInput:function(){var b,c=this.templateVars.inputId,d=this.addId?{id:c,name:c}:{},e=this.getModelVal();return b=a("<"+this.elementType+">"),"input"===this.elementType&&(d.type="text"),this.placeholder&&(d.placeholder=this.placeholder),b.attr(h(d,this.inputAttrs)),this.inputClass&&b.addClass(this.inputClass),this.getInputWrapper().html(b),e&&b.val(e),this},getInputWrapper:function(){var a=this.$(this.inputWrapper);return a.length?a.first():this.$el},disable:function(){var a=this.$(this.elementType);return this.isDisabled||a.attr("disabled")||(a.attr("disabled",!0),this.isDisabled=!0),this},enable:function(){return this.isDisabled&&(this.$(this.elementType).removeAttr("disabled"),this.isDisabled=!1),this},_getInputId:function(){return this.options.inputId||this.inputId||this.inputPrefix+this._getParentPrefix()+this.fieldName},_getParentPrefix:function(){return this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix(this)||"":""}}),b.fields.RadioListView=b.fields.FieldView.extend({tagName:"div",events:{"click input:radio":"setModelAttrs"},type:"radio-list",initialize:function(a){a=a||{},this.possibleVals=a.possibleVals||this.possibleVals||{},b.fields.RadioListView.__super__.initialize.call(this,a)},getValue:function(){return this.$(this.elementType+":checked").val()},renderInput:function(){var b,c=m(this,"possibleVals"),d=0,e=this,f=this.templateVars.inputId,i=this.getModelVal(),j=this.getInputWrapper().empty(),k=function(c,i){var j,k,l={type:"radio",value:b};return e.addId&&g(l,{name:f,id:f+"-"+d}),i&&(l.checked="checked"),j=a("<input>").attr(h(l,e.inputAttrs)),e.inputClass&&j.addClass(e.inputClass),k=a("<label>").attr("class","radio"),k.append(j).append(c),k};for(b in c)c.hasOwnProperty(b)&&(isNaN(Number(b))||(b=Number(b)),j.append(k(c[b],i+""==""+b)),d++);return this}}),b.fields.SelectListView=b.fields.RadioListView.extend({type:"select-list",elementType:"select",events:function(){var a={};return a["change "+this.elementType]="setModelAttrs",a},initialize:function(a){a=a||{},this.multiple=j(a.multiple)?this.multiple:a.multiple,b.fields.SelectListView.__super__.initialize.call(this,a)},getValue:function(){return this.$(this.elementType).val()},renderInput:function(){var b=m(this,"possibleVals"),c=this.getModelVal(),d=this.templateVars.inputId,e=a("<"+this.elementType+">").attr(h(this.addId?{id:d,name:d}:{},this.inputAttrs));return this.getInputWrapper().html(e),this.multiple&&e.attr("multiple","multiple"),this.inputClass&&e.addClass(this.inputClass),this.placeholder&&e.append('<option value="">'+this.placeholder+"</option>"),this._renderInput(e,b,c)},_renderInput:function(b,d,e){var f,g,h,i,j=function(a){return""+a},k=l(d);e=c.map(l(e)?e:[e],j);for(f in d)d.hasOwnProperty(f)&&(g=d[f],c.isObject(g)?(h=a('<optgroup label="'+f+'"></optgroup>').appendTo(b),this._renderInput(h,d[f],e)):(i=a("<option>").text(d[f]),k||(g=f,i.attr("value",f)),-1!==c.indexOf(e,j(g))&&i.attr("selected","selected"),i.appendTo(b)));return this}}),b.fields.CheckListView=b.fields.FieldView.extend({tagName:"div",type:"check-list",checkedVal:!0,unCheckedVal:!1,events:function(){var a={};return a["click "+this.elementType]="setModelAttrs",a},initialize:function(a){a=a||{},this.possibleVals=a.possibleVals||this.possibleVals||{},this.checkedVal=a.checkedVal||this.checkedVal,this.unCheckedVal=a.unCheckedVal||this.unCheckedVal,b.fields.CheckListView.__super__.initialize.call(this,a)},setupTwoWay:function(){f(m(this,"possibleVals"),function(a,b){this.listenTo(this.model,"change:"+b,function(){this._viewChangedModel||this.renderInput(),this._viewChangedModel=!1})},this)},setModelAttrs:function(b){var c={},d=a(b.target),e=d.val();c[e]=d.is(":checked")?this.checkedVal:this.unCheckedVal,this.model.set(c,this.setOpts)},renderInput:function(){var b,c,d=m(this,"possibleVals"),e=0,f=this.templateVars.inputId,i=this,j=this.getInputWrapper().empty(),k=function(b,d,j){var k,l;return c={type:"checkbox",value:b},i.addId&&g(c,{name:f,id:f+"-"+e}),j&&(c.checked="checked"),k=a("<input>").attr(h(c,i.inputAttrs)),i.inputClass&&k.addClass(i.inputClass),l=a("<label>").attr("class","checkbox"),l.append(k).append(d)};for(b in d)d.hasOwnProperty(b)&&(j.append(k(b,d[b],i.model.get(b)===i.checkedVal)),e++);return this}}),b.fields.CheckBoxView=b.fields.FieldView.extend({checkedVal:!0,unCheckedVal:!1,events:function(){var a={};return a["click "+this.elementType]="setModelAttrs",a},initialize:function(a){a=a||{},this.checkedVal=a.checkedVal||this.checkedVal,this.unCheckedVal=a.unCheckedVal||this.unCheckedVal,this.displayText=a.displayText||this.displayText,b.fields.CheckListView.__super__.initialize.call(this,a)},getValue:function(){return this.$("input:checkbox").prop("checked")?this.checkedVal:this.unCheckedVal},renderInput:function(){var b=a("<label>").attr("class","checkbox"),c=a("<input>").attr({type:"checkbox",value:this.checkedVal}),d=this.templateVars.inputId,e=this.getModelVal();return this.addId&&c.attr({id:d,name:d}),e===this.checkedVal&&c.attr("checked","checked"),b.append(c),this.displayText&&b.append(this.displayText),this.getInputWrapper().html(b),this.inputClass&&c.addClass(this.inputClass),this}}),b.FieldSetView=b.FormView.extend({tagName:"div",setupOnInit:!0,className:"",initialize:function(a){a=a||{},this.fieldSetName=a.fieldSetName||this.fieldSetName||a.schemaKey,b.FieldSetView.__super__.initialize.call(this,a),this.$el.addClass(this.className||"fieldset fieldset-"+this.fieldSetName)},getFieldPrefix:o,templateSrc:'<% if(obj && obj.label) { %><label class="fieldset-label"><strong><%= obj.label %></strong></label><% } %><fieldset data-fields=""></fieldset>'}),b.CollectionFieldSetView=b.CollectionFormView.extend({tagName:"div",templateSrc:'<% if(obj && obj.label) { %><p><strong><%= obj.label %></strong></p><% } %><fieldset class="fieldset" data-rows=""></fieldset>',setupOnInit:!0,className:"",initialize:function(a){return a=a||{},this.fieldSetName=a.fieldSetName||this.fieldSetName||a.schemaKey,b.CollectionFieldSetView.__super__.initialize.call(this,a),this.$el.addClass(this.className||"fieldset fieldset-"+this.fieldSetName),this},getFieldPrefix:o})}(jQuery,Backbone,_,this);