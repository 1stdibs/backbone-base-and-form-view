//     Backbone.FormView 0.3

//     (c) 2013 James Ballantine, 1stdibs.com Inc.
//     Backbone.FormView may be freely distributed under the MIT license.
//     For all details and documentation:
//     https://github.com/1stdibs/backbone-base-and-form-view
if(!Backbone||!Backbone.BaseView)throw new Error("Backbone and Backbone.BaseView required");!function(a,b,c){"use strict";var d=b.Model,e=b.Collection,f=c.each,g=c.extend,h=c.defaults,i=c.clone,j=c.isUndefined,k=c.isArray,l=c.result,m=function(a,b,c){return a instanceof c?a:a===!0&&b instanceof c?b:b?(b=b.get(a),b instanceof c?b:null):null},n=function(a,b,c){return a?m(a,c,d)||c:m(b,c,d)||c},o=function(a,b,c,d){return a?m(a,c,e)||d:m(b,c,e)||null};b.FormView=b.BaseView.extend({tagName:"form",className:"form-horizontal",fieldAlias:{Text:"Backbone.fields.FieldView",RadioList:"Backbone.fields.RadioListView",CheckList:"Backbone.fields.CheckListView",Select:"Backbone.fields.SelectListView",FieldSet:"Backbone.FieldSetView",Checkbox:"Backbone.fields.CheckBoxView",CollectionField:"Backbone.CollectionFieldSetView"},templateSrc:'<div data-fields=""></div>',initialize:function(){var a=this.options,b=a.schema||this.schema,d=j(a.setupOnInit)?this.setupOnInit:a.setupOnInit;this.subs.autoInitSingletons=!0,g(this,{templateSrc:a.templateSrc||this.templateSrc,templateVars:h(a.templateVars||this.templateVars||{},{label:a.label}),setupOnInit:a.setupOnInit||this.setupOnInit,validateOnSet:j(a.validateOnSet)?this.validateOnSet:a.validateOnSet,twoWay:j(a.twoWay)?this.twoWay:a.twoWay,autoUpdateModel:j(a.autoUpdateModel)?this.autoUpdateModel:a.autoUpdateModel}),this.template=a.template||c.template(this.templateSrc),this.subViewConfig=a.subViewConfig||null,b&&(this.setSchema(b),d&&this.setupFields()),this.autoUpdateModel&&this._setupAutoUpdate()},setSchema:function(a){return this.schema=a||this.schema,this},setupFields:function(){return this.subViewConfig=this._setupSubViewConfig(l(this,"schema")),this.subs.addConfig(this.subViewConfig),this},setModelAttrs:function(){return this.subs.invoke("setModelAttrs"),this},getFieldsWrapper:function(){var a=this.$("[data-fields]");return a.length?a:this.$el},render:function(){var b,a=this.options.fieldOrder||this.fieldOrder;if(this.subViewConfig||this.setupFields(),this.$el.html(this.template(this.templateVars)),this.options.attributes&&this.$el.attr(this.options.attributes),b=this.getFieldsWrapper(),a&&a.length)for(a=a.slice(0);a.length;)this.subs.renderByKey(a.shift(),b);else this.subs.renderAppend(b);return this},resetModels:function(){var a,c,d,f,g,h,l,i=0,j=this.subViews,m=j.length;for(i;m>i;i++)h=!1,f=this.subs.getSubViewType(j[i]),g=this.schema[f].options||{},a=j[i].model,c=n(g.model,f,this.model),a&&c&&c.cid!==a.cid&&(j[i].model=c,l=this.subs._subViewsByModelCid,l[c.cid]?k(l[c.cid])?l[c.cid].push(j[i]):l[c.cid]=[l[c.cid],j[i]]:l[c.cid]=j[i],h=!0),d=o(g.collection,f,this.model,this.collection),d&&j[i].collection instanceof e&&j[i].collection!==d&&(j[i].collection=d,h=!0),h&&j[i]instanceof b.BaseView&&j[i].bindViewEvents(),j[i]instanceof b.FormView&&j[i]._resetModels();return this},_setupSubViewConfig:function(a,b,d){var e,g,k,l=this,m={};return b=b||this.model,d=d||this.collection,f(a,function(a,f){k=m[f]=i(a),k.options=c.isFunction(a.options)?a.options.call(this):i(a.options||{}),e=k.options=k.options||{},k.singleton=void 0===k.singleton?!0:k.singleton,k.construct=l.fieldAlias[k.type||k.construct]||k.type||k.construct,e.model=n(e.model,f,b),this.validateOnSet&&(e.setOpts=h(e.setOpts||{},{validate:!0})),this.twoWay&&(e.twoWay=j(e.twoWay)?this.twoWay:e.twoWay),g=o(e.collection,f,b,d),g&&(e.collection=g),e.schema&&(e.subViewConfig=l._setupSubViewConfig(e.schema,e.model)),e.schemaKey=f},this),m},_setupAutoUpdate:function(){return this.model.on("change",function(a){f(a,function(a){a instanceof d&&this.resetModels()},this)},this),this}},{addFieldAlias:function(a,c){var d={},e=b.FormView.prototype.fieldAlias;c?d[a]=c:d=a,h(e,d)}}),b.CollectionFormRowView=b.FormView.extend({className:"form-field-row controls-row",tagName:"div",getFieldPrefix:function(){var a="";return this.parentView&&this.parentView.getFieldPrefix&&(a=this.parentView.getFieldPrefix(this)||""),a+this.options.index+"-"}}),b.CollectionFormView=b.BaseView.extend({tagName:"form",attributes:{"class":"form"},rowTemplateSrc:"",rowConfig:{singleton:!1,construct:b.CollectionFormRowView},initialize:function(){if(this.templateSrc=this.options.templateSrc||this.templateSrc,this.template=this.options.template||c.template(this.templateSrc||""),this.setupOnInit=j(this.options.setupOnInit)?this.setupOnInit:this.options.setupOnInit,this.rowOptions=this.options.rowOptions||this.rowOptions,this.templateVars=h(this.options.templateVars||{},{label:this.options.label}),this.options.rowConfig)this.rowConfig=this.options.rowConfig,this.rowConfig=l(this,"rowConfig");else{var a=g({},l(this,"rowOptions"),{schema:this.options.rowSchema||this.rowSchema||(this.rowConfig&&this.rowConfig.options?this.rowConfig.options.schema:null)});this.rowConfig.options=a}this.subs.addConfig("row",this.rowConfig),this.setupOnInit&&this.setupRows()},setRowSchema:function(a){return this.rowConfig.rowSchema=a||this.options.rowSchema||this.rowSchema,this},render:function(){return this.$el.html(this.template(this.templateVars)),this.subs.get("row")&&this.subs.get("row").length||this.setupRows(),this.subs.renderAppend(this.getRowWrapper()),this},getRowWrapper:function(){var a=this.$("[data-rows]");return a.length?a:this.$el},addRow:function(a){return a=a||new this.collection.model,k(a)||(a=[a]),this.collection.add(a),f(a,function(a){this._addRow(a).subs.last().render().$el.appendTo(this.getRowWrapper())},this),this},deleteRow:function(a){var c=a instanceof d?a:null,e=!c&&a instanceof b.View?a:null,g=c||e||!k(a)?null:a;return g?(f(g,this.deleteRow,this),this):(e?c||(c=e.model):e=this.subs.get(c),this.subs.remove(e),this.collection.remove(c),this)},setupRows:function(){return this.subs.remove("row"),this.collection.each(this._addRow,this),this},_addRow:function(a){var b=this.subs.add("row",this._getRowOptions(a)).last();return b.setSchema(this.rowSchema).setupFields(),this},_getRowOptions:function(a){return{model:a,index:this.subViews.length}}}),b.formTemplates=b.formTemplates||{},b.formTemplates.Field='<% if (label) { %><label class="control-label" <% if (inputId) { %> for="<%= inputId %>" <% } %> ><%= label %></label><% } %><div class="controls" data-input=""></div><div class="controls"><div class="text-error" data-error=""></div><% if (help) { %><span class="help-block"><%= help %></span><% } %></div>',b.fields=b.fields||{},b.fields.FieldView=b.BaseView.extend({tagName:"div",classDefaults:"control-group form-field",inputPrefix:"field-input-",fieldPrefix:"form-field-",template:c.template(b.formTemplates.Field),addId:!0,elementType:"input",events:function(){var a={};return a["blur "+this.elementType]="setModelAttrs",a},initialize:function(){var a=this.options;g(this,{templateVars:a.templateVars||{},fieldName:a.fieldName||a.schemaKey,elementType:a.elementType||this.elementType,templateSrc:j(a.templateSrc)?this.templateSrc:a.templateSrc,template:a.template||this.template,setOpts:h(a.setOpts||{},this.setOpts),twoWay:j(a.twoWay)?this.twoWay:a.twoWay,inputAttrs:a.inputAttrs||this.inputAttrs,placeholder:a.placeholder||this.placeholder,inputClass:a.inputClass||this.inputClass,addId:j(a.addId)?this.addId:a.addId}),g(this.templateVars,{inputId:this.addId?this._getInputId():!1,help:a.help,fieldName:this.fieldName,label:a.label}),this.template=this.templateSrc?c.template(this.templateSrc):this.template,a.className&&this.className||this.$el.addClass(this.fieldPrefix+this.fieldName),this.$el.addClass(this.classDefaults).attr("data-field",""),this.twoWay&&this.setupTwoWay&&this.setupTwoWay()},setupTwoWay:function(){return this.listenTo(this.model,"change:"+this.fieldName,function(){this._viewChangedModel||this.renderInput(),this._viewChangedModel=!1}),this},getAttrs:function(){var a={};return a[this.fieldName]=this.getValue(),a},setModelAttrs:function(){return this._viewChangedModel=!0,this.model.set(this.getAttrs(),this.setOpts)||(this._viewChangedModel=!1),this},getValue:function(){return a.trim(this.$(this.elementType).val())},getModelVal:function(){return this.model.get(this.fieldName)},render:function(){return this.renderWrapper().renderInput()},renderWrapper:function(a){return this.$el.html(this.template(a||this.templateVars)),this},renderInput:function(){var b,c=this.templateVars.inputId,d=this.addId?{id:c,name:c}:{},e=this.getModelVal();return b=a("<"+this.elementType+">"),"input"===this.elementType&&(d.type="text"),this.placeholder&&(d.placeholder=this.placeholder),b.attr(h(d,this.inputAttrs)),this.inputClass&&b.addClass(this.inputClass),this.getInputWrapper().html(b),e&&b.val(e),this},getInputWrapper:function(){var a=this.$("[data-input]");return a.length?a:this.$el},_getInputId:function(){return this.options.inputId||this.inputId||this.inputPrefix+this._getParentPrefix()+this.fieldName},_getParentPrefix:function(){return this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix(this)||"":""}}),b.fields.RadioListView=b.fields.FieldView.extend({tagName:"div",events:{"click input:radio":"setModelAttrs"},type:"radio-list",initialize:function(){this.possibleVals=this.options.possibleVals||this.possibleVals||{},b.fields.RadioListView.__super__.initialize.call(this)},getValue:function(){return this.$("input:radio:checked").val()},renderInput:function(){var c,b=l(this,"possibleVals"),d=0,e=this,f=this.templateVars.inputId,i=this.getModelVal(),j=this.getInputWrapper().empty(),k=function(b,i){var j,k,l={type:"radio",value:c};return e.addId&&g(l,{name:f,id:f+"-"+d}),i&&(l.checked="checked"),j=a("<input>").attr(h(l,e.inputAttrs)),e.inputClass&&j.addClass(e.inputClass),k=a("<label>").attr("class","radio"),k.append(j).append(b),k};for(c in b)b.hasOwnProperty(c)&&(isNaN(Number(c))||(c=Number(c)),j.append(k(b[c],i+""==""+c)),d++);return this}}),b.fields.SelectListView=b.fields.RadioListView.extend({type:"select-list",events:{"change select":"setModelAttrs"},initialize:function(){this.multiple=j(this.options.multiple)?this.multiple:this.options.multiple,b.fields.SelectListView.__super__.initialize.call(this)},getValue:function(){return this.$("select").val()},renderInput:function(){var b=l(this,"possibleVals"),c=this.getModelVal(),d=this.templateVars.inputId,e=a("<select>").attr(h(this.addId?{id:d,name:d}:{},this.inputAttrs));return this.getInputWrapper().html(e),this.multiple&&e.attr("multiple","multiple"),this.inputClass&&e.addClass(this.inputClass),this.placeholder&&e.append('<option value="">'+this.placeholder+"</option>"),this._renderInput(e,b,c)},_renderInput:function(b,d,e){var f,g,h,i,j=function(a){return""+a},l=k(d);e=c.map(k(e)?e:[e],j);for(f in d)d.hasOwnProperty(f)&&(g=d[f],c.isObject(g)?(h=a('<optgroup label="'+f+'"></optgroup>').appendTo(b),this._renderInput(h,d[f],e)):(i=a("<option>").text(d[f]),l||(g=f,i.attr("value",f)),-1!==c.indexOf(e,j(g))&&i.attr("selected","selected"),i.appendTo(b)))}}),b.fields.CheckListView=b.fields.FieldView.extend({tagName:"div",type:"check-list",checkedVal:"Y",unCheckedVal:"N",events:{"click input:checkbox":"setModelAttrs"},initialize:function(){var a=this.options;this.possibleVals=a.possibleVals||this.possibleVals||{},this.checkedVal=a.checkedVal||this.checkedVal,this.unCheckedVal=a.unCheckedVal||this.unCheckedVal,b.fields.CheckListView.__super__.initialize.call(this)},setupTwoWay:function(){f(l(this,"possibleVals"),function(a,b){this.listenTo(this.model,"change:"+b,function(){this._viewChangedModel||this.renderInput(),this._viewChangedModel=!1})},this)},setModelAttrs:function(b){var c={},d=a(b.target),e=d.val();c[e]=d.is(":checked")?this.checkedVal:this.unCheckedVal,this.model.set(c,this.setOpts)},renderInput:function(){var b,c,d=l(this,"possibleVals"),e=0,f=this.templateVars.inputId,i=this,j=this.getInputWrapper().empty(),k=function(b,d,j){var k,l;return c={type:"checkbox",value:b},this.addId&&g(c,{name:f,id:f+"-"+e}),j&&(c.checked="checked"),k=a("<input>").attr(h(c,i.inputAttrs)),i.inputClass&&k.addClass(i.inputClass),l=a("<label>").attr("class","checkbox"),l.append(k).append(d)};for(b in d)d.hasOwnProperty(b)&&(j.append(k(b,d[b],i.model.get(b)===i.checkedVal)),e++);return this}}),b.fields.CheckBoxView=b.fields.FieldView.extend({events:{"click input:checkbox":"setModelAttrs"},checkedVal:!0,unCheckedVal:!1,initialize:function(){var a=this.options;this.checkedVal=a.checkedVal||this.checkedVal,this.unCheckedVal=a.unCheckedVal||this.unCheckedVal,this.displayText=a.displayText||this.displayText,b.fields.CheckListView.__super__.initialize.call(this)},getValue:function(){return this.$("input:checkbox").prop("checked")?this.checkedVal:this.unCheckedVal},renderInput:function(){var b=a("<label>").attr("class","checkbox"),c=a("<input>").attr({type:"checkbox",value:this.checkedVal}),d=this.templateVars.inputId,e=this.getModelVal();return this.addId&&c.attr({id:d,name:d}),(e===!0||e===this.checkedVal)&&c.attr("checked","checked"),b.append(c),this.displayText&&b.append(this.displayText),this.getInputWrapper().html(b),this.inputClass&&c.addClass(this.inputClass),this}}),b.FieldSetView=b.FormView.extend({tagName:"div",className:"fieldset",setupOnInit:!0,render:function(){return b.FieldSetView.__super__.render.call(this),this.$el.addClass("fieldset-"+this.options.schemaKey),this},getFieldPrefix:function(){var a=this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix():"";return a+this.options.schemaKey+"-"},templateSrc:'<% if(obj && obj.label) { %><label class="fieldset-label"><strong><%= obj.label %></strong></label><% } %><fieldset data-fields=""></fieldset>'}),b.CollectionFieldSetView=b.CollectionFormView.extend({tagName:"div",className:"fieldset",templateSrc:'<% if(obj && obj.label) { %><p><strong><%= obj.label %></strong></p><% } %><fieldset class="fieldset" data-rows=""></fieldset>',setupOnInit:!0,getFieldPrefix:function(){var a=this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix():"";return a+this.options.schemaKey+"-"}})}(jQuery,Backbone,_,this);