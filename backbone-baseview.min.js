//     Backbone.BaseView 0.7.2
//     (c) 2014 James Ballantine, 1stdibs.com Inc.
//     Backbone.BaseView may be freely distributed under the MIT license.
//     For all details and documentation:
//     https://github.com/1stdibs/backbone-base-and-form-view
!function(a){"use strict";var b=a.Backbone,c=a._;"undefined"!=typeof module&&(c=require("underscore"),a=a||{},a.Backbone=b=require("backbone"),module.exports=b);var d,e=function(b){for(var c=b.split("."),d=a[c.shift()];c.length&&d;)d=d[c.shift()];return d},f=Array.prototype.slice,g=b.View,h=function(a,b,c){this.config={},this.clear(!0),this.parent=b,this.options=c||{},this.autoInitSingletons=!!this.options.autoInitSingletons,this.defaultToSingletons=this.options.defaultToSingletons,this.dotNotation=void 0!==this.options.dotNotation?this.options.dotNotation:!0,a&&this.addConfig(a)};h.prototype={add:function(a,b,d){var e,f,h,i=c.isArray(a)?a:c.isArray(b)?b:void 0,j=!i&&c.isObject(a)&&a instanceof g==!1?a:void 0,k=i||b instanceof g!=!1?void 0:b;if(j){d="boolean"==typeof b?b:void 0;for(e in j)if(j.hasOwnProperty(e))if(j[e]=c.isArray(j[e])?j[e]:[j[e]],h=j[e].length,h&&j[e][0]instanceof g)this._addInstance(e,j[e],d);else for(f=-1;++f<h;)this._init(e,j[e][f],d);return this}if(b=a instanceof g?a:b,a="string"==typeof a||"number"==typeof a?a:void 0,d="boolean"==typeof d?d:a||"boolean"!=typeof b?void 0:b,k)return this._init(a,k,d),this;if(i&&(h=i.length)){if(i[0]instanceof g)this._addInstance(a,i,d);else for(f=-1;++f<h;)this._init(a,i[f],d);return this}return b?this._addInstance(a,b,d):a&&this._init(a,d),this},addConfig:function(a,b){var d=c.isObject(a)&&!c.isArray(a)?a:!1;return d?(c.each(d,this._addConfig,this),this):this._addConfig(b,a)},render:function(a){a=a||{};var b=a.appendTo||a.useLocation;return this._render(this.subViews,b,a.clearLocations)},renderAppend:function(a,d){return d=d||{},c.isObject(a)&&a instanceof b.$==!1&&!c.isElement(a)&&(d=a,a=d.appendTo),this._render(this.subViews,a||!0,d.clearLocations)},renderByKey:function(a,b){var d=this.getByType(a)||this.get(a);return c.isArray(d)||(d=[d]),b=b||{},this._render(d,b.appendTo||b.useLocation,b.clearLocations)},filteredSubs:function(a){var b,d,e=-1,f=new h(null,this.parent,this.options);for(f.config=this.config,d=c.isArray(a)?a:c.isFunction(a)?this.filter(a):this.getByType(a),b=d.length;++e<b;)f.add(d[e]._subviewtype,d[e]);return f},descend:function(a,b){var d=c.isFunction(a),e=function(c){for(var f,g,h=-1,i=c.length;++h<i;)f=c[h],g=d?a:f[a],g&&(b?g.apply(f,b):g.call(c[h])),f.subViews&&f.subViews.length&&e(f.subViews)};return e(this.subViews),this},clear:function(a,b){return a||this.removeElems(),this.subViews=[],this.parent&&this.parent.subViews&&(this.parent.subViews=this.subViews),this._subViewsByType={},this._subViewSingletons={},this._subViewsByCid={},this._subViewsByModelCid={},b&&(this.config={}),this},remove:function(a,b){var d,e=a&&("string"==typeof a||a.cid)?this.get(a):a;if(!e)return this;for(c.isArray(e)||(e=[e]),d=e?e.length:0,b||this.removeElems(e),d&&this.trigger("remove",e);e&&e.length;)this._remove(e.shift());return this},removeElems:function(a){a=a||this.subViews;for(var b=-1,c=a.length;++b<c;)a[b].remove();return this},detachElems:function(a){a=a||this.subViews;for(var b=-1,c=a.length;++b<c;)a[b].$el.detach();return this},get:function(a){if(a.cid)return this._subViewsByCid[a.cid]||this._subViewsByModelCid[a.cid];if(a.indexOf(".")>-1&&this.dotNotation){for(var b=a.split("."),c=this.parent;b.length&&c;)c=c.subs.get(b.shift());return c}return this._subViewSingletons[a]||this._subViewsByCid[a]||this._subViewsByModelCid[a]||this._subViewsByType[a]},getByType:function(a){return this._subViewsByType[a]?this._subViewsByType[a]:this._subViewSingletons[a]?[this._subViewSingletons[a]]:[]},getSubViewType:function(a){return a=a instanceof g==!0?a:this.get(a),a._subviewtype},at:function(a){return this.subViews[a]},clearLocations:function(a){var b=a?c.pick(this.config,a):this.config;return c.each(b,function(a){this.parent.$(a.location).html("")},this),this},_render:function(a,c,d){var e,f,g=-1,h={};for(c!==!0&&(e=c),d&&this.clearLocations();++g<a.length;)if(a[g].render(),e)a[g].$el.appendTo("string"==typeof e?this.parent.$(e).first():e);else if(c&&(f=this.config[this.getSubViewType(a[g])].location)){if("string"==typeof f)h[f]||(h[f]=this.parent.$(f).first()),f=h[f];else if("function"==typeof f&&(f=f.call(a[g]),!(f instanceof b.$)))throw new Error("location function must return instance of jQuery");f.append(a[g].$el)}return this},_addInstance:function(a,b,d){var e,f=-1,g=this;if(a=a||"_svid_"+c.size(this.config),g._subViewSingletons[a])return g;for(c.isArray(b)||(b=[b]),e=b.length,!g.config[a]&&b[0].constructor&&(g.config[a]={options:b[0].options||{},construct:b[0].constructor,singleton:d}),d=void 0===d?g.config[a].singleton:d;++f<e;)g._setInst(a,b[f],d);return g},_addConfig:function(a,b){return this.config[b]=a,this.autoInitSingletons&&a.singleton?this._init(b):this},_remove:function(a,b){for(var c=-1,d=this.subViews.length,e=this.getSubViewType(a),f=this.getByType(e);++c<d;)if(this.subViews[c].cid===a.cid){this.subViews.splice(c,1);break}if(d=f?f.length:0,!this._subViewSingletons[e]&&d)for(c=0;d>c;c++)if(f[c].cid===a.cid){f.splice(c,1);break}return delete this._subViewsByCid[a.cid],a.model&&a.model.cid&&this._subViewsByModelCid[a.model.cid]&&delete this._subViewsByModelCid[a.model.cid],this._subViewSingletons[e]&&delete this._subViewSingletons[e],b?void 0:this.trigger("remove:"+e,a)},_setInst:function(a,b,d,e){var f=b.model?b.model.cid:null,g=this._subViewsByModelCid;return this.subViews.push(b),this._subViewsByCid[b.cid]=b,b.parentView||(b.parentView=this.parent),b._subviewtype=a,f&&(g[f]?(c.isArray(g[f])||(g[f]=[g[f]]),g[f].push(b)):this._subViewsByModelCid[f]=b),d="boolean"==typeof d?d:this.defaultToSingletons,d?this._subViewSingletons[a]=b:(this._subViewsByType[a]||(this._subViewsByType[a]=[]),this._subViewsByType[a].push(b)),this.newest=b,e?this:this.trigger("add",b).trigger("add:"+a,b)},_init:function(a,b,d){var f,g=this.config[a],h=g&&g.construct?g.construct:null;return b=c.extend({},g.options||{},b||{}),this._subViewSingletons[a]?this:(h="string"==typeof h?e(h):h,h||console.error('Construct for key "'+a+'" was not found:',g?g.construct:""),f=new h(b,this.parent),this._setInst(a,f,void 0!==d?d:g.singleton),this)}},c.each(["each","map","initial","rest","last","first","find","filter","sortBy","groupBy","where","findWhere","some","every","invoke","contains","max","min","size","without","indexOf","lastIndexOf","isEmpty","reject"],function(a){h.prototype[a]=function(){return c[a].apply(this,[this.subViews].concat(f.call(arguments)))}}),c.extend(h.prototype,b.Events),d=g.extend({subViews:null,subs:null,subViewConfig:null,autoInitSubViews:!1,singletonSubViews:!1,parentView:null,_stopPropogation:!1,constructor:function(a,b){var e=a&&a.subViewConfig?c.result(a,"subViewConfig"):c.result(this,"subViewConfig");this.parentView=b instanceof g?b:null,this.subs=new h(null,this,{autoInitSingletons:this.autoInitSubViews,defaultToSingletons:this.singletonSubViews}),e&&this.subs.addConfig(e),this.subViews=this.subs.subViews,d.__super__.constructor.call(this,a),this.viewEvents=a&&a.viewEvents?a.viewEvents:this.viewEvents,this.viewEvents&&this.bindViewEvents()},place:function(a,c){if("string"==typeof a){var d=this.parentView?this.parentView.$el:b.$("body");a=d.find(a)}return c?(a.html(this.el),this):(a.append(this.el),this)},stopEvent:function(){return this._stopPropogation=!0,this},triggerBubble:function(a){var b,c=f.call(arguments,1);for(c.unshift(a),c.push(this),b=this;b;){if(b.trigger.apply(b,c),b._stopPropogation)return b._stopPropogation=!1,this;b=b.parentView}return this},triggerDescend:function(a){var b=f.call(arguments,1),c=function(a){for(var d,e,f=-1,g=a.length;++f<g;)e=!0,a[f].trigger.apply(a[f],b),a[f]._stopPropogation&&(a[f]._stopPropogation=!1,e=!1),d=a[f].subViews,e&&d&&d.length&&c(d)};return b.unshift(a),b.push(this),c([this]),this},ascend:function(a,b){for(var d,e=this,f=c.isFunction(a);e.parentView;)e=e.parentView,e&&(d=f?a:e[a],d.apply(e,b));return this},findAncestor:function(a){for(var b=this;b.parentView;)if(b=b.parentView,b&&a(b))return b;return null},findAncestorByConstruct:function(a){return this.findAncestor(function(b){return b instanceof a})},findAncestorByType:function(a){return this.findAncestor(function(b){return a&&b._subviewtype===a})},getSubViewType:function(){return this._subviewtype},getTopView:function(){for(var a=this;a.parentView;)a=a.parentView;return a},isTopView:function(){return!this.parentView},bindViewEvents:function(a){return a=a||c.result(this,"viewEvents"),c.each(a,function(a,b){var d=b.split(" "),e=d.length>1?this[d[1]]:this;a=c.isFunction(a)?a:this[a],e&&(this.stopListening(e,d[0],a),this.listenTo(e,d[0],a))},this),this}}),b.BaseView=d}(this);