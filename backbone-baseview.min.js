//     Backbone.BaseView 0.4.0
//     (c) 2013 James Ballantine, 1stdibs.com Inc.
//     Backbone.BaseView may be freely distributed under the MIT license.
//     For all details and documentation:
//     https://github.com/1stdibs/backbone-base-and-form-view
!function(a){"use strict";var b=a.jQuery,c=a.Backbone,d=a._;"undefined"!=typeof module&&(b=require("jquery").create(),d=require("underscore"),c=require("Backbone"),module.exports=c);var e,f=function(b){for(var c=b.split("."),d=a[c.shift()];c.length&&d;)d=d[c.shift()];return d},g=Array.prototype.slice,h=c.View,i=function(a,b,c){this._subViews={},this.clear(!0),this.parent=b,this.options=c||{},this.autoInitSingletons=!!this.options.autoInitSingletons,this.defaultToSingletons=this.options.defaultToSingletons,this.dotNotation=void 0!==this.options.dotNotation?this.options.dotNotation:!0,a&&this.addConfig(a)};i.prototype={add:function(a,b,c){var e,f,g,i=d.isArray(a)?a:d.isArray(b)?b:void 0,j=!i&&d.isObject(a)&&a instanceof h==!1?a:void 0,k=i||b instanceof h!=!1?void 0:b;if(j){c="boolean"==typeof b?b:void 0;for(e in j)if(j.hasOwnProperty(e))if(j[e]=d.isArray(j[e])?j[e]:[j[e]],g=j[e].length,g&&j[e][0]instanceof h)this._addInstance(e,j[e],c);else for(f=-1;++f<g;)this._init(e,j[e][f],c);return this}if(b=a instanceof h?a:b,a="string"==typeof a||"number"==typeof a?a:void 0,c="boolean"==typeof c?c:a||"boolean"!=typeof b?void 0:b,k)return this._init(a,k,c),this;if(i&&(g=i.length)){if(i[0]instanceof h)this._addInstance(a,i,c);else for(f=-1;++f<g;)this._init(a,i[f],c);return this}return b?this._addInstance(a,b,c):a&&this._init(a,c),this},addConfig:function(a,b){var c=d.isObject(a)&&!d.isArray(a)?a:!1;return c?(d.each(c,this._addConfig,this),this):this._addConfig(b,a)},render:function(a){a=a||{};var b=a.appendTo||a.useLocation;return this._render(this.subViews,b,a.clearLocations)},renderAppend:function(a,c){return c=c||{},d.isObject(a)&&a instanceof b==!1&&!d.isElement(a)&&(c=a,a=c.appendTo),this._render(this.subViews,a||!0,c.clearLocations)},renderByKey:function(a,b){var c=this.getByType(a)||this.get(a);return d.isArray(c)||(c=[c]),b=b||{},this._render(c,b.appendTo||b.useLocation,b.clearLocations)},filteredSubs:function(a){var b,c,e=-1,f=new i(null,this.parent,this.options);for(f._subViews=this._subViews,c=d.isArray(a)?a:d.isFunction(a)?this.filter(a):this.getByType(a),b=c.length;++e<b;)f.add(c[e]._subviewtype,c[e]);return f},descend:function(a,b){var c=d.isFunction(a),e=function(d){for(var f,g,h=-1,i=d.length;++h<i;)f=d[h],g=c?a:f[a],g&&(b?g.apply(f,b):g.call(d[h])),f.subViews&&f.subViews.length&&e(f.subViews)};return e(this.subViews),this},clear:function(a,b){return a||this.removeElems(),this.subViews=[],this.parent&&this.parent.subViews&&(this.parent.subViews=this.subViews),this._subViewsByType={},this._subViewSingletons={},this._subViewsByCid={},this._subViewsByModelCid={},b&&(this._subViews={}),this},remove:function(a,b){var c,e=a&&("string"==typeof a||a.cid)?this.get(a):a;if(!e)return this;for(d.isArray(e)||(e=[e]),c=e?e.length:0,b||this.removeElems(e),c&&this.trigger("remove",e);e&&e.length;)this._remove(e.shift());return this},removeElems:function(a){a=a||this.subViews;for(var b=-1,c=a.length;++b<c;)a[b].remove();return this},get:function(a){if(a.cid)return this._subViewsByCid[a.cid]||this._subViewsByModelCid[a.cid];if(a.indexOf(".")>-1&&this.dotNotation){for(var b=a.split("."),c=this.parent;b.length&&c;)c=c.subs.get(b.shift());return c}return this._subViewSingletons[a]||this._subViewsByCid[a]||this._subViewsByModelCid[a]||this._subViewsByType[a]},getByType:function(a){return this._subViewsByType[a]?this._subViewsByType[a]:this._subViewSingletons[a]?[this._subViewSingletons[a]]:[]},getSubViewType:function(a){return a=a instanceof h==!0?a:this.get(a),a._subviewtype},at:function(a){return this.subViews[a]},clearLocations:function(a){var b=a?d.pick(this._subViews,a):this._subViews;return d.each(b,function(a){this.parent.$(a.location).html("")},this),this},_render:function(a,b,c){var d,e,f=-1,g=a.length,h={};for(b!==!0&&(d=b),c&&this.clearLocations();++f<g;)a[f].render(),d?a[f].$el.appendTo("string"==typeof d?this.parent.$(d):d):b&&(e=this._subViews[this.getSubViewType(a[f])].location)&&("string"==typeof e&&(h[e]||(h[e]=this.parent.$(e)),e=h[e]),e.append(a[f].$el));return this},_addInstance:function(a,b,c){var e,f=-1,g=this;if(a=a||"_svid_"+d.size(this._subViews),g._subViewSingletons[a])return g;for(d.isArray(b)||(b=[b]),e=b.length,!g._subViews[a]&&b[0].constructor&&(g._subViews[a]={options:b[0].options||{},construct:b[0].constructor,singleton:c}),c=void 0===c?g._subViews[a].singleton:c;++f<e;)g._setInst(a,b[f],c);return g},_addConfig:function(a,b){return this._subViews[b]=a,this.autoInitSingletons&&a.singleton?this._init(b):this},_remove:function(a,b){for(var c=-1,d=this.subViews.length,e=this.getSubViewType(a),f=this.getByType(e);++c<d;)if(this.subViews[c].cid===a.cid){this.subViews.splice(c,1);break}if(d=f?f.length:0,!this._subViewSingletons[e]&&d)for(c=0;d>c;c++)if(f[c].cid===a.cid){f.splice(c,1);break}return delete this._subViewsByCid[a.cid],a.model&&a.model.cid&&this._subViewsByModelCid[a.model.cid]&&delete this._subViewsByModelCid[a.model.cid],this._subViewSingletons[e]&&delete this._subViewSingletons[e],b?void 0:this.trigger("remove:"+e,a)},_setInst:function(a,b,c,e){var f=b.model?b.model.cid:null,g=this._subViewsByModelCid;return this.subViews.push(b),this._subViewsByCid[b.cid]=b,b.parentView||(b.parentView=this.parent),b._subviewtype=a,f&&(g[f]?(d.isArray(g[f])||(g[f]=[g[f]]),g[f].push(b)):this._subViewsByModelCid[f]=b),c="boolean"==typeof c?c:this.defaultToSingletons,c?this._subViewSingletons[a]=b:(this._subViewsByType[a]||(this._subViewsByType[a]=[]),this._subViewsByType[a].push(b)),e?this:this.trigger("add",b).trigger("add:"+a,b)},_init:function(a,b,c){var e,g=this._subViews[a],h=g&&g.construct?g.construct:null;return b=d.extend({},g.options||{},b||{}),this._subViewSingletons[a]?this:(h="string"==typeof h?f(h):h,h||console.log("Construct for key "+a+" was not found",g?g.construct:""),e=new h(b,this.parent),this._setInst(a,e,void 0!==c?c:g.singleton),this)}},d.each(["each","initial","rest","last","first","find","filter","sortBy","groupBy","where","findWhere","some","every","invoke"],function(a){i.prototype[a]=function(){return d[a].apply(this,[this.subViews].concat(g.call(arguments)))}}),d.extend(i.prototype,c.Events),e=h.extend({subViews:null,subs:null,subViewConfig:null,autoInitSubViews:!1,singletonSubViews:!1,parentView:null,_stopPropogation:{},constructor:function(a,b){var c=a&&a.subViewConfig?d.result(a,"subViewConfig"):d.result(this,"subViewConfig");this.parentView=b instanceof h?b:null,this.subs=new i(null,this,{autoInitSingletons:this.autoInitSubViews,defaultToSingletons:this.singletonSubViews}),c&&this.subs.addConfig(c),this.subViews=this.subs.subViews,e.__super__.constructor.call(this,a),this.viewEvents=a&&a.viewEvents?a.viewEvents:this.viewEvents,this.viewEvents&&this.bindViewEvents()},place:function(a,c){if("string"==typeof a){var d=this.parentView?this.parentView.$el:b("body");a=d.find(a)}return c?(a.html(this.el),this):(a.append(this.el),this)},stopEvent:function(a){return this._stopPropogation[a]=!0,this},triggerBubble:function(a){var b,c=g.call(arguments,1);if(c.unshift(a),c.push(this),this.trigger.apply(this,c),this._stopPropogation[a])return this._stopPropogation[a]=!1,this;for(b=this.parentView;b;){if(b._stopPropogation&&b._stopPropogation[a])return b._stopPropogation[a]=!1,this;b.trigger.apply(b,c),b=b.parentView}return this},triggerDescend:function(a){var b=g.call(arguments,1),c=function(d){for(var e,f,g,h=-1,i=d.length;++h<i;)g=!0,(f=d[h]._stopPropogation)&&f[a]&&(f[a]=!1,g=!1),d[h].trigger.apply(d[h],b),e=d[h].subViews,g&&e&&e.length&&c(e)};return b.unshift(a),b.push(this),c([this]),this},findAncestor:function(a){for(var b=this;b.parentView;)if(b=b.parentView,b&&a&&a===b._subviewtype)return b;return null},getSubViewType:function(){return this._subviewtype},getTopView:function(){for(var a=this;a.parentView;)a=a.parentView;return a},isTopView:function(){return!this.parentView},bindViewEvents:function(a){return a=a||d.result(this,"viewEvents"),d.each(a,function(a,b){var c=b.split(" "),e=c.length>1?this[c[1]]:this;a=d.isFunction(a)?a:this[a],e&&(this.stopListening(e,c[0],a),this.listenTo(e,c[0],a))},this),this}}),c.BaseView=e}(this);